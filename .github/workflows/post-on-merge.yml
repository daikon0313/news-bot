name: "Post Tweets on PR Merge"

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  post-tweets:
    # Only run when the PR was actually merged (not just closed)
    # and the branch name starts with "tweets/"
    if: >-
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'tweets/')
    runs-on: ubuntu-latest
    env:
      X_API_KEY: ${{ secrets.X_API_KEY }}
      X_API_SECRET: ${{ secrets.X_API_SECRET }}
      X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
      X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Determine session type from branch name
        id: session
        env:
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          echo "branch=$PR_BRANCH" >> "$GITHUB_OUTPUT"

          if echo "$PR_BRANCH" | grep -q "morning"; then
            echo "type=morning" >> "$GITHUB_OUTPUT"
          elif echo "$PR_BRANCH" | grep -q "evening"; then
            echo "type=evening" >> "$GITHUB_OUTPUT"
          else
            echo "type=unknown" >> "$GITHUB_OUTPUT"
          fi

          # Extract the date portion from branch name (tweets/morning-YYYY-MM-DD)
          DATE=$(echo "$PR_BRANCH" | grep -oP '\d{4}-\d{2}-\d{2}')
          echo "date=$DATE" >> "$GITHUB_OUTPUT"
          echo "Session: branch=$PR_BRANCH, date=$DATE"

      - name: Verify X API credentials
        run: |
          python3 -c "
          import os, tweepy
          ck = os.environ.get('X_API_KEY','').strip()
          cs = os.environ.get('X_API_SECRET','').strip()
          at = os.environ.get('X_ACCESS_TOKEN','').strip()
          ats = os.environ.get('X_ACCESS_SECRET','').strip()
          print(f'Credential lengths: API_KEY={len(ck)}, API_SECRET={len(cs)}, ACCESS_TOKEN={len(at)}, ACCESS_SECRET={len(ats)}')
          client = tweepy.Client(consumer_key=ck, consumer_secret=cs, access_token=at, access_token_secret=ats)
          try:
              client.get_me()
              print('OK: Authentication successful')
          except tweepy.Unauthorized as e:
              print(f'FAIL: 401 Unauthorized - credentials are INVALID')
              if hasattr(e, 'response') and e.response is not None:
                  print(f'Response: {e.response.text}')
              raise SystemExit(1)
          except tweepy.Forbidden:
              print('OK: Auth works (403 = endpoint restricted on Free tier, expected)')
          except Exception as e:
              print(f'Other error: {type(e).__name__}: {e}')
          "

      - name: Post tweets to X
        env:
          SESSION_TYPE: ${{ steps.session.outputs.type }}
          DATE: ${{ steps.session.outputs.date }}
        run: |
          python scripts/post_to_x.py \
            --session-type "$SESSION_TYPE" \
            --date "$DATE"

      - name: Move drafts to posted and commit
        env:
          SESSION_TYPE: ${{ steps.session.outputs.type }}
          DATE: ${{ steps.session.outputs.date }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          git config user.name "news-bot"
          git config user.email "news-bot@users.noreply.github.com"

          # Move posted draft files to posted/ directory
          if ls drafts/tweets_${SESSION_TYPE}_${DATE}* 1>/dev/null 2>&1; then
            cp drafts/tweets_${SESSION_TYPE}_${DATE}* posted/
          fi

          # Also capture any post result logs
          if ls drafts/posted_* 1>/dev/null 2>&1; then
            mv drafts/posted_* posted/
          fi

          git add -f posted/ drafts/
          git diff --cached --quiet && echo "No changes to archive" && exit 0
          git commit -m "Archive posted tweets: ${SESSION_TYPE} ${DATE}"
          git push origin main

      - name: Send notification (posted)
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          SESSION_TYPE: ${{ steps.session.outputs.type }}
          DATE: ${{ steps.session.outputs.date }}
        run: |
          python scripts/notify.py posted \
            --session-type "$SESSION_TYPE" \
            --date "$DATE"

      - name: Clean up remote branch
        continue-on-error: true
        env:
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          git push origin --delete "$PR_BRANCH" || true
