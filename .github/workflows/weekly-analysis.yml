name: "Weekly Engagement Analysis"

on:
  schedule:
    # Every Monday UTC 00:00 = JST 09:00
    - cron: "0 0 * * 1"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  weekly-analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Get date range (JST)
        id: dates
        run: |
          WEEK_END=$(TZ=Asia/Tokyo date +%Y-%m-%d)
          WEEK_START=$(TZ=Asia/Tokyo date -d '7 days ago' +%Y-%m-%d)
          echo "week_start=$WEEK_START" >> "$GITHUB_OUTPUT"
          echo "week_end=$WEEK_END" >> "$GITHUB_OUTPUT"
          echo "Analysis period: $WEEK_START to $WEEK_END"

      - name: Analyze posted tweets
        env:
          WEEK_START: ${{ steps.dates.outputs.week_start }}
          WEEK_END: ${{ steps.dates.outputs.week_end }}
        run: |
          python3 scripts/weekly_report.py "$WEEK_START" "$WEEK_END" > /tmp/weekly_report.md

      - name: Display report in logs
        run: cat /tmp/weekly_report.md

      - name: Send Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          REPORT=$(cat /tmp/weekly_report.md | head -c 2900)
          jq -n --arg text "$REPORT" \
            '{"text":":bar_chart: Weekly Tweet Analysis Report","blocks":[{"type":"section","text":{"type":"mrkdwn","text":$text}}]}' \
            > /tmp/slack_payload.json
          curl -s -X POST -H 'Content-type: application/json' \
            --data @/tmp/slack_payload.json \
            "$SLACK_WEBHOOK_URL"
          echo "Slack notification sent."

      - name: Send Discord notification
        if: env.DISCORD_WEBHOOK_URL != ''
        continue-on-error: true
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          REPORT=$(cat /tmp/weekly_report.md | head -c 1900)
          jq -n --arg text "$REPORT" \
            '{"content":("**Weekly Tweet Analysis Report**\n\n" + $text)}' \
            > /tmp/discord_payload.json
          curl -s -X POST -H 'Content-type: application/json' \
            --data @/tmp/discord_payload.json \
            "$DISCORD_WEBHOOK_URL"
          echo "Discord notification sent."
